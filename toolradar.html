<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ToolRadar – V-Modell & KI (Open Source)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a33;
      --panel2:#0c1630;
      --line:#223055;
      --text:#e7eefc;
      --muted:#a7b7dd;
      --ok:#7ee787;
      --err:#ff7b72;
      --btn:#2b63ff;
      --btn2:#1b2a52;
      --pill:#2a3e78;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:16px 20px; background:var(--panel); border-bottom:1px solid var(--line);
      position:sticky; top:0; z-index:10;
    }
    a{ color:#9cc2ff; text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .wrap{ max-width:1200px; margin:0 auto; padding:20px; }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      margin:14px 0;
    }
    h1,h2,h3{ margin:0 0 10px 0; }
    .row{ display:flex; gap:14px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:260px; }
    .muted{ color:var(--muted); }
    .small{ font-size:12px; }
    .status{ margin-top:8px; }
    .ok{ color:var(--ok); }
    .err{ color:var(--err); }
    .controls{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:flex-end;
    }
    input, select{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--pill);
      background:var(--bg);
      color:var(--text);
      outline:none;
    }
    label{ display:block; margin:0 0 6px 0; }
    button{
      background:var(--btn);
      border:none;
      color:white;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
    }
    button.secondary{
      background:var(--btn2);
      border:1px solid var(--pill);
    }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--pill);
      margin:2px 6px 0 0;
      font-size:12px;
      color:#cfe0ff;
      white-space:nowrap;
    }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid var(--line); padding:10px; vertical-align:top; text-align:left; }
    th{ color:#bcd3ff; font-size:13px; position:sticky; top:62px; background:var(--panel); }
    .grid2{ display:grid; grid-template-columns: 1.2fr 1fr; gap:14px; }
    @media (max-width: 980px){ .grid2{ grid-template-columns: 1fr; } th{ top:62px; } }
    .canvas-wrap{
      background:var(--panel2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    canvas{ width:100%; height:auto; display:block; }
    .kv{ display:grid; grid-template-columns: 160px 1fr; gap:8px 10px; }
    .kv div{ padding:2px 0; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <header>
    <div>
      <div style="font-weight:800;">ToolRadar</div>
      <div class="muted small">Open Source · V-Modell-Mapping · Heuristische Scores (0–5) · RadarChart</div>
    </div>
    <div class="small">
      <a href="./index.html">↩ Zur Hauptseite</a>
      <span class="muted"> · </span>
      <a id="runLink" href="#" target="_blank" rel="noopener">Scan manuell starten</a>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <div class="muted small">Datenquelle</div>
          <div class="mono small">/data/toolradar_tools.json</div>
        </div>
        <div class="status small" id="status">Bereit.</div>
      </div>
      <div class="muted small" id="meta" style="margin-top:10px;"></div>
    </div>

    <div class="grid2">
      <div class="card">
        <h2>RadarChart</h2>
        <div class="row">
          <div>
            <label class="small muted">Tool auswählen</label>
            <select id="toolSelect"></select>
          </div>
          <div>
            <label class="small muted">Dimensionen</label>
            <select id="dimPreset">
              <option value="default" selected>Standard (7D)</option>
              <option value="quality">Quality Fokus</option>
              <option value="cost">Cost/Community Fokus</option>
            </select>
          </div>
        </div>

        <div class="canvas-wrap" style="margin-top:12px;">
          <canvas id="radar" width="520" height="520"></canvas>
        </div>

        <div style="margin-top:12px;" class="small muted">
          Scores sind heuristisch aus GitHub-Metadaten/Keywords abgeleitet (Stars, Aktualität, Beschreibung).
        </div>
      </div>

      <div class="card">
        <h2>Tool Details</h2>
        <div id="toolDetails" class="kv small"></div>
        <div style="margin-top:12px;">
          <div class="muted small">Evidence</div>
          <div id="evidence" class="small"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Filter & Liste</h2>
      <div class="row">
        <div>
          <label class="small muted">Suche (Name/Vendor/Use)</label>
          <input id="q" placeholder="z.B. zephyr, simulation, analysis, mlops..." />
        </div>
        <div>
          <label class="small muted">V-Modell Phase</label>
          <select id="phase">
            <option value="">Alle</option>
            <option>Stakeholder Needs / System Requirements</option>
            <option>Architektur/Design</option>
            <option>Implementierung</option>
            <option>Integration & Test (Komponenten)</option>
            <option>System Integration & Validierung</option>
            <option>Release / Operations</option>
            <option>Safety & Security</option>
            <option>Data/AI Lifecycle</option>
            <option>Documentation & Audit</option>
          </select>
        </div>
        <div>
          <label class="small muted">AI Involvement</label>
          <select id="ai">
            <option value="">Alle</option>
            <option value="none">none</option>
            <option value="assisted">assisted</option>
            <option value="core">core</option>
          </select>
        </div>
      </div>

      <div style="overflow:auto; margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th style="min-width:220px;">Tool</th>
              <th style="min-width:160px;">Vendor</th>
              <th style="min-width:260px;">Phasen</th>
              <th style="min-width:90px;">AI</th>
              <th style="min-width:90px;">Class</th>
              <th style="min-width:160px;">Repo</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>Signals & Broken Links</h2>
      <div class="row">
        <div>
          <button class="secondary" id="refresh">Neu laden</button>
        </div>
      </div>

      <h3 style="margin-top:12px;">Signals</h3>
      <div id="signals" class="small muted" style="white-space:pre-wrap;"></div>

      <h3 style="margin-top:12px;">Broken Links</h3>
      <div id="broken" class="small muted" style="white-space:pre-wrap;"></div>
    </div>
  </div>

<script>
  const DATA_TOOLS = "./data/toolradar_tools.json";
  const DATA_META = "./data/toolradar_meta.json";
  const DATA_SIGNALS = "./data/toolradar_signals.json";

  let TOOLS = [];
  let META = null;
  let SIGNALS = null;

  const DIMENSIONS = ["Maturity","Integration","EmbeddedFit","AuditTraceability","AIValue","TCO","CommunitySupport"];

  function setStatus(msg, cls="muted"){
    const el = document.getElementById("status");
    el.className = `status small ${cls}`;
    el.textContent = msg;
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function fmtPills(list){
    return (list || []).map(x => `<span class="pill">${escapeHtml(x)}</span>`).join("");
  }

  function toolKey(t){ return (t?.ToolName || "").toLowerCase().trim(); }

  async function loadAll(){
    setStatus("Lade JSON…");
    try{
      const [toolsRes, metaRes, sigRes] = await Promise.all([
        fetch(DATA_TOOLS, {cache:"no-store"}),
        fetch(DATA_META, {cache:"no-store"}),
        fetch(DATA_SIGNALS, {cache:"no-store"}),
      ]);
      TOOLS = await toolsRes.json();
      META = await metaRes.json();
      SIGNALS = await sigRes.json();

      const metaText = `Last run (UTC): ${META?.lastRunUtc || "n/a"} · Tools: ${META?.toolsCount ?? TOOLS.length}`;
      document.getElementById("meta").textContent = metaText;

      setStatus(`OK: ${TOOLS.length} Tools geladen.`, "ok");
      initUI();
      renderTable();
      renderSignals();
    }catch(e){
      setStatus(`Fehler beim Laden: ${e}`, "err");
    }
  }

  function initUI(){
    // GitHub Actions link
    const runLink = document.getElementById("runLink");
    runLink.href = "https://github.com/gudiri1/ibstech-website/actions/workflows/toolradar-scan.yml";

    // Filters
    ["q","phase","ai"].forEach(id => document.getElementById(id).addEventListener("input", renderTable));
    document.getElementById("refresh").addEventListener("click", loadAll);

    // Tool selector
    const sel = document.getElementById("toolSelect");
    sel.innerHTML = "";
    const sorted = [...TOOLS].sort((a,b)=> (a.ToolName||"").localeCompare(b.ToolName||""));
    for(const t of sorted){
      const opt = document.createElement("option");
      opt.value = toolKey(t);
      opt.textContent = t.ToolName || "Unnamed";
      sel.appendChild(opt);
    }
    if(sorted.length){
      sel.value = toolKey(sorted[0]);
      renderToolDetails(sorted[0]);
      drawRadar(sorted[0], DIMENSIONS);
    }
    sel.addEventListener("change", ()=>{
      const t = TOOLS.find(x => toolKey(x) === sel.value);
      if(t){
        renderToolDetails(t);
        drawRadar(t, getDims());
      }
    });

    document.getElementById("dimPreset").addEventListener("change", ()=>{
      const t = TOOLS.find(x => toolKey(x) === document.getElementById("toolSelect").value);
      if(t) drawRadar(t, getDims());
    });
  }

  function getDims(){
    const preset = document.getElementById("dimPreset").value;
    if(preset === "quality"){
      return ["Maturity","AuditTraceability","Integration","CommunitySupport","EmbeddedFit","AIValue","TCO"];
    }
    if(preset === "cost"){
      return ["TCO","CommunitySupport","Maturity","Integration","EmbeddedFit","AIValue","AuditTraceability"];
    }
    return DIMENSIONS;
  }

  function renderToolDetails(t){
    const d = document.getElementById("toolDetails");
    const scores = t.Scores || {};
    const repo = t.Repo || {};

    d.innerHTML = `
      <div class="muted">Name</div><div><strong>${escapeHtml(t.ToolName)}</strong></div>
      <div class="muted">Vendor</div><div>${escapeHtml(t.VendorOrganisation)}</div>
      <div class="muted">Type</div><div>${escapeHtml(t.ToolType)}</div>
      <div class="muted">PrimaryUse</div><div>${escapeHtml(t.PrimaryUse)}</div>
      <div class="muted">VModel</div><div>${fmtPills(t.VModelPhases)}</div>
      <div class="muted">AI</div><div><span class="pill">${escapeHtml(t.AIInvolvement)}</span></div>
      <div class="muted">Class</div><div><span class="pill">${escapeHtml(t.Classification || "")}</span></div>
      <div class="muted">LastVerified</div><div>${escapeHtml(t.LastVerifiedDate)}</div>
      <div class="muted">Stars</div><div>${escapeHtml(repo.stars ?? "")}</div>
      <div class="muted">Forks</div><div>${escapeHtml(repo.forks ?? "")}</div>
      <div class="muted">Updated</div><div>${escapeHtml(repo.pushed_at ?? "")}</div>
      <div class="muted">Scores</div>
      <div>${Object.keys(scores).map(k=>`<span class="pill">${escapeHtml(k)}:${escapeHtml(scores[k])}</span>`).join("")}</div>
    `;

    const ev = document.getElementById("evidence");
    const links = (t.EvidenceLinks || []).slice(0,2);
    ev.innerHTML = links.map(u => `<div><a href="${u}" target="_blank" rel="noopener">${escapeHtml(u)}</a></div>`).join("");
  }

  function filteredTools(){
    const q = (document.getElementById("q").value || "").toLowerCase().trim();
    const phase = document.getElementById("phase").value || "";
    const ai = document.getElementById("ai").value || "";

    return TOOLS.filter(t=>{
      const blob = `${t.ToolName||""} ${t.VendorOrganisation||""} ${t.PrimaryUse||""}`.toLowerCase();
      if(q && !blob.includes(q)) return false;
      if(ai && (t.AIInvolvement||"").toLowerCase() !== ai) return false;
      if(phase){
        const phases = t.VModelPhases || [];
        if(!phases.includes(phase)) return false;
      }
      return true;
    });
  }

  function renderTable(){
    const list = filteredTools();
    const tb = document.getElementById("tbody");
    tb.innerHTML = "";

    for(const t of list){
      const repo = t.Repo || {};
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <strong>${escapeHtml(t.ToolName)}</strong>
          <div class="muted small">${escapeHtml(t.PrimaryUse || "")}</div>
        </td>
        <td>${escapeHtml(t.VendorOrganisation || "")}</td>
        <td>${fmtPills(t.VModelPhases)}</td>
        <td><span class="pill">${escapeHtml(t.AIInvolvement || "")}</span></td>
        <td><span class="pill">${escapeHtml(t.Classification || "")}</span></td>
        <td class="small">
          ${repo.url ? `<a href="${repo.url}" target="_blank" rel="noopener">Repo</a>` : ""}
          <div class="muted small">★ ${escapeHtml(repo.stars ?? "")} · Forks ${escapeHtml(repo.forks ?? "")}</div>
        </td>
      `;
      tr.style.cursor = "pointer";
      tr.addEventListener("click", ()=>{
        document.getElementById("toolSelect").value = toolKey(t);
        renderToolDetails(t);
        drawRadar(t, getDims());
        window.scrollTo({top: 0, behavior: "smooth"});
      });
      tb.appendChild(tr);
    }
  }

  function renderSignals(){
    const sigEl = document.getElementById("signals");
    const broEl = document.getElementById("broken");
    const s = SIGNALS || {};
    const lines = [];
    lines.push(`generated_at_utc: ${s.generated_at_utc || "n/a"}`);
    lines.push("");

    const sigs = s.signals || [];
    if(!sigs.length){
      lines.push("(keine Signals)");
    } else {
      for(const x of sigs.slice(0,60)){
        if(x.type === "ERROR"){
          lines.push(`[ERROR] ${x.message}`);
        } else {
          lines.push(`[${x.type}] ${x.tool || ""} (${x.vendor || ""})`);
        }
      }
    }
    sigEl.textContent = lines.join("\n");

    const broken = s.broken_links || [];
    if(!broken.length){
      broEl.textContent = "(keine Broken Links)";
    } else {
      broEl.textContent = broken.slice(0,80).map(b => `- ${b.tool}: ${b.link} (${b.info})`).join("\n");
    }
  }

  function drawRadar(tool, dims){
    const canvas = document.getElementById("radar");
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;

    ctx.clearRect(0,0,w,h);

    // Geometry
    const cx = w/2, cy = h/2;
    const padding = 90;
    const radius = Math.min(w,h)/2 - padding;

    // Background
    ctx.fillStyle = "rgba(12, 22, 48, 1)";
    ctx.fillRect(0,0,w,h);

    const levels = 5;

    // Grid
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(255,255,255,0.08)";
    for(let l=1;l<=levels;l++){
      const r = radius * (l/levels);
      ctx.beginPath();
      for(let i=0;i<dims.length;i++){
        const a = -Math.PI/2 + (i*(2*Math.PI/dims.length));
        const x = cx + r*Math.cos(a);
        const y = cy + r*Math.sin(a);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.closePath();
      ctx.stroke();
    }

    // Axes + labels
    ctx.strokeStyle = "rgba(255,255,255,0.14)";
    ctx.fillStyle = "rgba(231,238,252,0.95)";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";

    for(let i=0;i<dims.length;i++){
      const a = -Math.PI/2 + (i*(2*Math.PI/dims.length));
      const x = cx + radius*Math.cos(a);
      const y = cy + radius*Math.sin(a);

      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.lineTo(x,y);
      ctx.stroke();

      const lx = cx + (radius+18)*Math.cos(a);
      const ly = cy + (radius+18)*Math.sin(a);

      const label = dims[i];
      ctx.textAlign = (Math.cos(a) > 0.2) ? "left" : (Math.cos(a) < -0.2) ? "right" : "center";
      ctx.textBaseline = (Math.sin(a) > 0.2) ? "top" : (Math.sin(a) < -0.2) ? "bottom" : "middle";
      ctx.fillText(label, lx, ly);
    }

    // Polygon
    const scores = tool.Scores || {};
    const values = dims.map(d => Math.max(0, Math.min(5, Number(scores[d] ?? 0))));

    ctx.beginPath();
    for(let i=0;i<dims.length;i++){
      const a = -Math.PI/2 + (i*(2*Math.PI/dims.length));
      const r = radius * (values[i]/levels);
      const x = cx + r*Math.cos(a);
      const y = cy + r*Math.sin(a);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.fillStyle = "rgba(43, 99, 255, 0.25)";
    ctx.strokeStyle = "rgba(43, 99, 255, 0.85)";
    ctx.lineWidth = 2;
    ctx.fill();
    ctx.stroke();

    // Points
    ctx.fillStyle = "rgba(231,238,252,0.9)";
    for(let i=0;i<dims.length;i++){
      const a = -Math.PI/2 + (i*(2*Math.PI/dims.length));
      const r = radius * (values[i]/levels);
      const x = cx + r*Math.cos(a);
      const y = cy + r*Math.sin(a);
      ctx.beginPath();
      ctx.arc(x,y,3,0,2*Math.PI);
      ctx.fill();
    }

    // Title
    ctx.fillStyle = "rgba(231,238,252,0.95)";
    ctx.font = "700 14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "top";
    ctx.fillText(tool.ToolName || "Tool", cx, 14);
  }

  loadAll();
</script>
</body>
</html>
